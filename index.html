<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Kinshasa | GPS & 3 Communes</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --t-yellow: #FFD700; --t-blue: #4169E1; --t-dark: #121212; }
        body, html { height: 100%; margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; background: #f0f0f0; }
        
        /* Header */
        .app-header {
            position: absolute; top: 0; width: 100%; z-index: 2000;
            background: white; padding: 12px 20px; border-bottom: 3px solid var(--t-yellow);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .logo-sq { background: var(--t-blue); color: white; width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; border: 2px solid var(--t-yellow); }

        /* Map */
        #map { height: 100vh; width: 100%; position: absolute; z-index: 1; }

        /* Card UI */
        .tambola-card {
            position: absolute; bottom: 0; width: 100%; max-width: 500px; 
            left: 50%; transform: translateX(-50%);
            background: white; z-index: 1000; border-top-left-radius: 35px; border-top-right-radius: 35px;
            padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }

        .search-area { background: #f8f9fa; border-radius: 20px; padding: 10px; margin-bottom: 15px; }
        .input-row { display: flex; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; }
        .input-row:last-child { border-bottom: none; }
        .input-row input { border: none; background: transparent; width: 100%; font-weight: 600; outline: none; margin-left: 10px; font-size: 0.9rem; }

        /* Transport */
        .transport-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .transport-item { border: 2px solid #eee; border-radius: 18px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
        .transport-item.active { border-color: var(--t-blue); background: #f0f4ff; transform: scale(1.02); }
        .price-tag { display: block; font-weight: 800; font-size: 0.8rem; margin-top: 5px; color: var(--t-blue); }

        /* Autocomplete */
        #suggestions {
            position: absolute; background: white; width: calc(100% - 40px);
            border-radius: 15px; bottom: 410px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 180px; overflow-y: auto; z-index: 1005; display: none;
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 0.85rem; }

        .btn-main { background: var(--t-dark); color: white; border: none; width: 100%; padding: 16px; border-radius: 18px; font-weight: 800; font-size: 1rem; }
        .stat-pill { background: #f0f0f0; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: #444; }

        /* GPS Status Pulse */
        .gps-pulse { width: 10px; height: 10px; background: #28a745; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 0 rgba(40, 167, 69, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
    </style>
</head>
<body>

<header class="app-header">
    <div class="d-flex align-items-center gap-2">
        <div class="logo-sq">T</div>
        <div>
            <span class="fw-bold d-block" style="line-height: 1.1;">TAMBOLA</span>
            <small class="text-primary fw-bold" style="font-size: 0.6rem;">GPS LIVE • KINSHASA</small>
        </div>
    </div>
    <div class="d-flex gap-2">
        <div class="stat-pill"><i class="bi bi-geo-fill"></i> <span id="s-trips">0</span></div>
        <div class="stat-pill"><i class="bi bi-clock-history"></i> <span id="s-mins">0</span>m</div>
    </div>
</header>

<div id="map"></div>
<div id="suggestions"></div>

<div class="tambola-card">
    <div class="search-area">
        <div class="input-row">
            <div id="gps-indicator" class="gps-pulse"></div>
            <input type="text" id="origin" placeholder="Recherche de votre position..." value="Position GPS en cours..." readonly>
        </div>
        <div class="input-row">
            <i class="bi bi-plus-circle-fill text-warning"></i>
            <input type="text" id="stopover" placeholder="Ajouter un arrêt (Escale)" oninput="filterSearch(this.value, 'stop')">
        </div>
        <div class="input-row">
            <i class="bi bi-geo-alt-fill text-danger"></i>
            <input type="text" id="destination" placeholder="Destination (Lemba, Limete, Matete)" oninput="filterSearch(this.value, 'dest')">
        </div>
    </div>

    <div class="transport-grid">
        <div class="transport-item active" onclick="setActive(this)">
            <i class="bi bi-bicycle fs-5"></i><br><small>Moto</small>
            <span class="price-tag" id="p-moto">-- FC</span>
        </div>
        <div class="transport-item" onclick="setActive(this)">
            <i class="bi bi-car-front fs-5"></i><br><small>Taxi</small>
            <span class="price-tag" id="p-taxi">-- FC</span>
        </div>
        <div class="transport-item" onclick="setActive(this)">
            <i class="bi bi-award-fill fs-5"></i><br><small>VIP</small>
            <span class="price-tag" id="p-vip">-- FC</span>
        </div>
    </div>

    <button class="btn-main shadow" onclick="bookTrip()">COMMANDER LA COURSE</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Initialisation Carte
    const defaultPos = [-4.325, 15.322]; // Centre Kinshasa
    const map = L.map('map', { zoomControl: false }).setView(defaultPos, 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    let markers = { origin: L.marker(defaultPos).addTo(map), stop: null, dest: null };
    let routePath = null;
    let currentInput = '';
    let distance = 0;

    // 2. Module GPS Automatique au démarrage
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const myCoords = [pos.coords.latitude, pos.coords.longitude];
                    markers.origin.setLatLng(myCoords);
                    map.setView(myCoords, 15);
                    document.getElementById('origin').value = "Ma Position Actuelle";
                    document.getElementById('gps-indicator').style.background = "#28a745";
                },
                (err) => {
                    document.getElementById('origin').value = "GPS non autorisé";
                    document.getElementById('gps-indicator').style.background = "#dc3545";
                    alert("Pour une meilleure expérience, activez votre GPS.");
                },
                { enableHighAccuracy: true }
            );
        }
        updateUI();
    };

    // 3. Recherche Filtrée (Lemba, Limete, Matete)
    async function filterSearch(query, type) {
        currentInput = type;
        const list = document.getElementById("suggestions");
        if (query.length < 2) { list.style.display="none"; return; }

        const allowed = ["lemba", "limete", "matete"];
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}+kinshasa&countrycodes=cd&limit=15`);
        const data = await res.json();
        
        const filtered = data.filter(item => 
            allowed.some(commune => item.display_name.toLowerCase().includes(commune))
        );

        list.innerHTML = "";
        if(filtered.length > 0) {
            list.style.display = "block";
            filtered.forEach(item => {
                const d = document.createElement("div");
                d.className = "suggestion-item";
                d.innerHTML = `<strong>${item.display_name.split(',')[0]}</strong> <small class="text-muted">RDC</small>`;
                d.onclick = () => selectLocation(item);
                list.appendChild(d);
            });
        }
    }

    function selectLocation(item) {
        const coords = [parseFloat(item.lat), parseFloat(item.lon)];
        document.getElementById(currentInput === 'stop' ? 'stopover' : 'destination').value = item.display_name.split(',')[0];
        document.getElementById("suggestions").style.display = "none";
        
        if (markers[currentInput]) map.removeLayer(markers[currentInput]);
        markers[currentInput] = L.marker(coords).addTo(map);
        calculateRoute();
    }

    // 4. Calcul Itinéraire & Prix
    function calculateRoute() {
        const pts = [markers.origin.getLatLng()];
        if (markers.stop) pts.push(markers.stop.getLatLng());
        if (markers.dest) pts.push(markers.dest.getLatLng());

        if (routePath) map.removeLayer(routePath);
        if (pts.length > 1) {
            routePath = L.polyline(pts, {color: '#4169E1', weight: 5, dashArray: '5, 10'}).addTo(map);
            map.fitBounds(routePath.getBounds(), {padding: [50, 150]});
            
            distance = 0;
            for(let i=0; i<pts.length-1; i++) distance += pts[i].distanceTo(pts[i+1]);
            distance /= 1000;
            
            // Tarifs en FC (Francs Congolais)
            const stopBonus = markers.stop ? 1500 : 0;
            document.getElementById('p-moto').innerText = Math.round(distance * 650 + 1000 + stopBonus) + " FC";
            document.getElementById('p-taxi').innerText = Math.round(distance * 1300 + 2500 + stopBonus) + " FC";
            document.getElementById('p-vip').innerText = Math.round(distance * 3000 + 5000 + (stopBonus*2)) + " FC";
        }
    }

    function bookTrip() {
        if(!markers.dest) return alert("Veuillez choisir une destination (Lemba, Limete ou Matete)");
        const mins = Math.round(distance * 7); // Temps moyen Kinshasa
        const data = JSON.parse(localStorage.getItem('tambola_v3')) || {t:0, m:0};
        data.t += 1; data.m += mins;
        localStorage.setItem('tambola_v3', JSON.stringify(data));
        alert(`Course confirmée ! Arrivée estimée dans ${mins} min.`);
        updateUI();
    }

    function updateUI() {
        const data = JSON.parse(localStorage.getItem('tambola_v3')) || {t:0, m:0};
        document.getElementById('s-trips').innerText = data.t;
        document.getElementById('s-mins').innerText = data.m;
    }

    function setActive(el) {
        document.querySelectorAll('.transport-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }
</script>
</body>
</html>